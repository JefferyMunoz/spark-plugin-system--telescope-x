<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    :root {
      --bg: #ffffff;
      --text: #1d1d1f;
      --secondary: #86868b;
      --accent: #000000;
      --border: #d2d2d7;
      --item-hover: #f5f5f7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: transparent;
      color: var(--text);
      overflow: hidden;
      padding: 20px; /* 恢复内边距给阴影留出呼吸空间 */
    }
    .card {
      background: var(--bg);
      border-radius: 18px;
      height: 100%;
      display: flex;
      flex-direction: column;
      /* 乔布斯式分层阴影：外层弥散阴影 + 物理轮廓阴影 + 极细边框 */
      box-shadow: 
        0 0 0 1px rgba(0,0,0,0.05), /* 极细物理边框 */
        0 10px 30px rgba(0,0,0,0.1), /* 弥散阴影 */
        0 20px 50px -10px rgba(0,0,0,0.2); /* 物理深层阴影 */
      border: 0.5px solid rgba(255,255,255,0.8); /* 边缘高光，增加质感 */
      overflow: hidden;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
    }
    .card.shrinking {
      transform: scale(0.85) translateY(20px);
      opacity: 0;
    }
    .header {
      padding: 16px 20px;
      border-bottom: 0.5px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      -webkit-app-region: drag; /* 允许拖动 */
      cursor: move;
    }
    .dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px rgba(16,185,129,0.5); }
    .title { font-size: 11px; font-weight: 800; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.1em; }
    
    .list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      -webkit-app-region: no-drag;
    }
    .list::-webkit-scrollbar { display: none; }
    
    .item {
      padding: 14px 18px;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 4px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
    .item:hover { background: var(--item-hover); }
    .item.selected { background: var(--accent); color: #ffffff; transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    
    .label { 
      font-size: 13px; 
      font-weight: 700; 
      letter-spacing: -0.01em;
    }
    
    .value { display: none; } /* 隐藏具体值 */

    .enter-icon {
      font-size: 10px;
      font-weight: 800;
      opacity: 0.3;
      text-transform: uppercase;
    }
    .item.selected .enter-icon { opacity: 0.6; }

    .footer {
      padding: 12px 20px;
      background: #fbfbfd;
      border-top: 0.5px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: drag;
    }
    .hint { font-size: 10px; font-weight: 600; color: var(--secondary); }
    .tag { background: #fff; border: 1px solid var(--border); padding: 2px 6px; border-radius: 6px; color: var(--text); font-size: 9px; margin-right: 4px; }
  </style>
</head>
<body>
  <div class="card" id="app-card">
    <div class="header">
      <div class="dot"></div>
      <span class="title">闪搭X</span>
    </div>
    <div class="list" id="list"></div>
    <div class="footer">
      <div class="hint"><span class="tag">↑↓</span> 选择</div>
      <div class="hint"><span class="tag">Enter</span> 复制</div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const params = new URLSearchParams(window.location.search);
    const rawText = params.get('text') || "";
    
    let items = [];
    let selectedIdx = 0;

    const add = (label, value) => {
      items.push({ label, value: value || "无数据" });
    };

    // --- 1. 同步主页面所有转换逻辑 ---
    // JSON
    try {
      const p = JSON.parse(rawText);
      add("JSON 美化", JSON.stringify(p, null, 2));
      add("JSON 压缩", JSON.stringify(p));
    } catch(e) {
      if (rawText.includes('{')) add("JSON 美化", "格式错误 (无法美化)");
    }

    // Base64
    const b64 = {
        encode: (s) => { try { return btoa(unescape(encodeURIComponent(s))); } catch(e) { return null; } },
        decode: (s) => {
            try { return decodeURIComponent(escape(atob(s.replace(/\s/g, '')))); } 
            catch(e) { try { return atob(s.replace(/\s/g, '')); } catch(e2) { return null; } }
        }
    };
    add("Base64 编码", b64.encode(rawText));
    add("Base64 解码", b64.decode(rawText));

    // URL
    add("URL 编码", encodeURIComponent(rawText));
    try { add("URL 解码", decodeURIComponent(rawText)); } catch(e) { add("URL 解码", "无效编码"); }

    // 时间戳
    if (/^\d{10,13}$/.test(rawText)) {
      const d = new Date(rawText.length === 10 ? rawText * 1000 : rawText * 1);
      add("时间戳转日期", d.toLocaleString());
    } else {
      const d = new Date(rawText);
      if (!isNaN(d.getTime())) add("日期转时间戳", d.getTime().toString());
    }

    // JWT
    if (rawText.split('.').length === 3) {
      try {
        const payload = JSON.parse(atob(rawText.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
        add("JWT 解析 (Payload)", JSON.stringify(payload, null, 2));
      } catch(e) { add("JWT 解析", "令牌格式无效"); }
    }

    // Unicode
    if (rawText) {
      add("Unicode 编码", rawText.replace(/[^\u0000-\u007f]/g, c => "\\u" + c.charCodeAt(0).toString(16).padStart(4, '0')));
      add("Unicode 解码", rawText.replace(/\\u([0-9a-fA-F]{4})/g, (_, g) => String.fromCharCode(parseInt(g, 16))));
    }

    // 默认添加一个 SHA-256
    add("SHA-256 摘要", "正在计算...");

    async function updateSHA() {
      const msg = new TextEncoder().encode(rawText);
      const buf = await crypto.subtle.digest('SHA-256', msg);
      const sha = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
      const idx = items.findIndex(it => it.label === "SHA-256 摘要");
      if (idx !== -1) {
        items[idx].value = sha;
        render();
      }
    }
    updateSHA();

    // 根据习惯排序 (localStorage)
    const freq = JSON.parse(localStorage.getItem('ts_freq') || '{}');
    items.sort((a, b) => (freq[b.label] || 0) - (freq[a.label] || 0));

    function render() {
      const container = document.getElementById('list');
      if (items.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:100px 20px;color:#ccc;font-size:12px;font-weight:700;">无可转换项</div>';
        return;
      }
      container.innerHTML = items.map((it, i) => `
        <div class="item ${i === selectedIdx ? 'selected' : ''}" onclick="doCopy(${i})">
          <div class="label">${it.label}</div>
          <div class="enter-icon">⏎</div>
        </div>
      `).join('');
      const active = container.querySelector('.selected');
      if (active) active.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }


    window.doCopy = (i) => {
      const targetIdx = (i !== undefined && i !== null) ? i : selectedIdx;
      const item = items[targetIdx];
      if (!item) return;
      
      // 如果是错误提示，不执行复制
      if (item.value.includes("格式错误") || item.value === "无数据" || item.value === "无效编码" || item.value === "正在计算...") return;
      
      const freqData = JSON.parse(localStorage.getItem('ts_freq') || '{}');
      freqData[item.label] = (freqData[item.label] || 0) + 1;
      localStorage.setItem('ts_freq', JSON.stringify(freqData));

      ipcRenderer.send('ts-copy', item.value);
      
      document.getElementById('app-card').classList.add('shrinking');
      setTimeout(() => {
        ipcRenderer.send('ts-notify', { title: 'TeleScopeX', body: `已成功复制 [${item.label}] 结果` });
        ipcRenderer.send('ts-close');
      }, 200);
    };

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowDown') { selectedIdx = (selectedIdx + 1) % items.length; render(); e.preventDefault(); }
      if (e.key === 'ArrowUp') { selectedIdx = (selectedIdx - 1 + items.length) % items.length; render(); e.preventDefault(); }
      if (e.key === 'Enter') doCopy();
      if (e.key === 'Escape') ipcRenderer.send('ts-close');
    });

    render();
  </script>
</body>
</html>
